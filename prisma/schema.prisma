// prisma/schema.prisma
datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

/// ==================== ENUMS ====================

enum Role {
  USER
  ADMIN
  SUPERADMIN
}

enum AdminPermission {
  CREATE
  UPDATE
  DELETE
  READ
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

/// ==================== MODELS ====================

model Auth {
  id        String   @id @default(cuid())
  emailId   String   @unique
  password  String
  role      Role
  createdAt DateTime @default(now())

  adminId      String?
  superAdminId String?
  userId       String?

  Admin      Admin?      @relation("AdminToAuth", fields: [adminId], references: [id], onDelete: Cascade)
  superadmin SuperAdmin? @relation(fields: [superAdminId], references: [id], onDelete: Cascade)
  user       User?       @relation(fields: [userId], references: [id], onDelete: Cascade)

  PasswordDetails PasswordDetails?
}

/// ----------- Super Admin -----------

model SuperAdmin {
  id              String   @id @default(cuid())
  title           String
  firstName       String
  middleName      String?
  lastName        String
  officialEmailId String   @unique
  personalEmailId String
  phNo            BigInt
  alternativePhNo BigInt?
  createdAt       DateTime @default(now())

  PersonalInfo       PersonalInfo?      @relation("SuperAdminToPersonalInfo")
  admins             Admin[]            @relation("SuperAdminCreatedAdmins")
  updatedPermissions AdminPermissions[] @relation("UpdatedBySuperAdmin")
  Auth               Auth[]
}

/// ----------- Admin -----------

model Admin {
  id              String   @id @default(cuid())
  title           String
  firstName       String
  middleName      String?
  lastName        String
  officialEmailId String   @unique
  personalEmailId String
  phNo            BigInt
  alternativePhNo BigInt?
  createdAt       DateTime @default(now())
  createdById     String

  createdBy          SuperAdmin             @relation("SuperAdminCreatedAdmins", fields: [createdById], references: [id])
  personalInfo       PersonalInfo?          @relation("AdminToPersonalInfo")
  permissions        AdminPermissions?      @relation("AdminToPermissions")
  Auth               Auth[]                 @relation("AdminToAuth")
  updatedDatasets    DatasetUpdateHistory[] @relation("UpdatedDatasets")
  updatedPermissions AdminPermissions[]     @relation("UpdatedByAdmin")

  birthInfosCreated BirthInfo[] @relation("AdminToBirthInfo")
  birthInfosUpdated BirthInfo[] @relation("AdminToBirthInfoUpdater")
}

/// ----------- Admin Permissions -----------

model AdminPermissions {
  id                    String            @id @default(cuid())
  permissions           AdminPermission[]
  updatedBySuperAdminId String?
  updatedByAdminId      String?
  lastUpdatedAt         DateTime          @default(now())

  adminId String @unique
  admin   Admin  @relation("AdminToPermissions", fields: [adminId], references: [id], onDelete: Cascade)

  updatedBySuperAdmin SuperAdmin? @relation("UpdatedBySuperAdmin", fields: [updatedBySuperAdminId], references: [id])
  updatedByAdmin      Admin?      @relation("UpdatedByAdmin", fields: [updatedByAdminId], references: [id], onDelete: SetNull)
}

/// ----------- Personal Info -----------
model PersonalInfo {
  id          String   @id @default(cuid())
  address     String
  aadharUrl   String?
  panCardUrl  String?
  fatherName  String
  motherName  String
  gender      Gender
  dob         DateTime
  city        String
  state       String
  country     String
  pinCode     String
  nationality String

  adminId      String?     @unique
  superAdminId String?     @unique
  admin        Admin?      @relation("AdminToPersonalInfo", fields: [adminId], references: [id], onDelete: Cascade)
  superAdmin   SuperAdmin? @relation("SuperAdminToPersonalInfo", fields: [superAdminId], references: [id], onDelete: Cascade)
}

/// ----------- User -----------

model User {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  phNo      BigInt
  createdAt DateTime @default(now())

  datasets DatasetLookup[]
  cart     Cart[]
  Auth     Auth[]
}

/// ----------- Password Details -----------

model PasswordDetails {
  id                      String    @id @default(cuid())
  userId                  String    @unique
  password                String
  previousLogin           DateTime?
  updatePasswordTimeStamp DateTime

  auth Auth @relation(fields: [userId], references: [id])
}

/// ----------- Dataset -----------
model Dataset {
  id                String  @id @default(cuid())
  title             String
  primaryCategoryId String
  sourceId          String
  price             Float
  isPaid            Boolean
  license           String
  superTypes        String

  aboutDatasetId String? @unique
  birthInfoId    String? @unique
  locationId     String? @unique
  securityId     String? @unique

  primaryCategory Category @relation("DatasetPrimaryCategory", fields: [primaryCategoryId], references: [id])
  source          Source   @relation("DatasetSource", fields: [sourceId], references: [id])

  aboutDataset AboutDataset? @relation("DatasetToAboutDataset", fields: [aboutDatasetId], references: [id])
  birthInfo    BirthInfo?    @relation("DatasetToBirthInfo", fields: [birthInfoId], references: [id])
  location     Location?     @relation("DatasetToLocation", fields: [locationId], references: [id])
  security     Security?     @relation("DatasetToSecurity", fields: [securityId], references: [id])

  datasetLookups DatasetLookup[]
  categories     CategoryLookup[]
  updateHistory  DatasetUpdateHistory[]
  carts          Cart[]
}

/// ----------- About Dataset -----------

model AboutDataset {
  id           String @id @default(cuid())
  overview     String
  description  String
  dataQuality  String
  dataFormatId String

  dataFormat DataFormat @relation(fields: [dataFormatId], references: [id])
  features   Features[]

  // Back-reference to Dataset (Dataset owns the relationship)
  dataset Dataset? @relation("DatasetToAboutDataset")
}

/// ----------- Features -----------

model Features {
  id           String       @id @default(cuid())
  aboutId      String
  content      String
  AboutDataset AboutDataset @relation(fields: [aboutId], references: [id], onDelete: Cascade)
}

/// ----------- Data Format -----------

model DataFormat {
  id           String         @id @default(cuid())
  rows         Int
  cols         Int
  fileFormat   String
  AboutDataset AboutDataset[]
}

/// ----------- Birth Info -----------

model BirthInfo {
  id                 String   @id @default(cuid())
  creatorAdminId     String
  createdAt          DateTime @default(now())
  lastUpdaterAdminId String
  lastUpdatedAt      DateTime @default(now())

  creatorAdmin Admin @relation("AdminToBirthInfo", fields: [creatorAdminId], references: [id])
  lastUpdater  Admin @relation("AdminToBirthInfoUpdater", fields: [lastUpdaterAdminId], references: [id])

  dataset Dataset? @relation("DatasetToBirthInfo")
}

/// ----------- Source -----------

model Source {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())

  // Updated relation name to avoid conflicts
  datasets Dataset[] @relation("DatasetSource")
}

/// ----------- Location -----------

model Location {
  id      String @id @default(cuid())
  region  String
  country String
  state   String
  city    String

  // Back-reference to Dataset (Dataset owns the relationship)
  dataset Dataset? @relation("DatasetToLocation")
}

/// ----------- Security -----------

model Security {
  id                      String @id @default(cuid())
  currentEncryptionSecret String
  masterSecret            String

  // Back-reference to Dataset (Dataset owns the relationship)
  dataset Dataset? @relation("DatasetToSecurity")
}

/// ----------- Dataset Update History -----------

model DatasetUpdateHistory {
  id        String   @id @default(cuid())
  datasetId String
  adminId   String
  reason    String
  updatedAt DateTime @default(now())

  dataset Dataset @relation(fields: [datasetId], references: [id], onDelete: Cascade)
  admin   Admin   @relation("UpdatedDatasets", fields: [adminId], references: [id])
}

/// ----------- Dataset Lookup -----------

model DatasetLookup {
  id           String   @id @default(cuid())
  userId       String
  datasetId    String
  purchaseDate DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id])
  dataset Dataset @relation(fields: [datasetId], references: [id], onDelete: Cascade)

  @@unique([userId, datasetId])
}

/// ----------- Category Lookup -----------

model CategoryLookup {
  id         String @id @default(cuid())
  datasetId  String
  categoryId String

  dataset  Dataset  @relation(fields: [datasetId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id])

  @@unique([datasetId, categoryId])
}

/// ----------- Category -----------

model Category {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  createdBy String

  // Updated relations
  primaryDatasets Dataset[]        @relation("DatasetPrimaryCategory")
  CategoryLookup  CategoryLookup[]
}

/// ----------- Cart -----------

model Cart {
  id        String   @id @default(cuid())
  userId    String
  datasetId String
  addedAt   DateTime @default(now())
  isInCart  Boolean

  user    User    @relation(fields: [userId], references: [id])
  dataset Dataset @relation(fields: [datasetId], references: [id], onDelete: Cascade)

  @@unique([userId, datasetId])
}
